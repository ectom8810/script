-- ===== é‡è¤‡åŒ¯å…¥å®‰å…¨ Loader =====

-- å¦‚æœå·²å­˜åœ¨èˆŠå¯¦ä¾‹ â†’ å…ˆå¸è¼‰
if _G.__FAST_ATTACK_LOADER__ then
    _G.__FAST_ATTACK_LOADER__.Stop()
end

-- å»ºç«‹æ–° Loader
local Loader = {
    Running = true,
    Connections = {}
}

_G.__FAST_ATTACK_LOADER__ = Loader

-- ===== å¿«æ·é€£ç·šè¨»å†Š =====
local function Track(conn)
    table.insert(Loader.Connections, conn)
    return conn
end

-- ===== åœæ­¢ / å¸è¼‰ =====
function Loader.Stop()
    if not Loader.Running then return end
    Loader.Running = false

    for _, conn in ipairs(Loader.Connections) do
        pcall(function()
            conn:Disconnect()
        end)
    end

    Loader.Connections = {}
    _G.__FAST_ATTACK_LOADER__ = nil

    warn("â›” FastAttack Loader å·²å¸è¼‰")
end

--------------------------------------------------
-- ğŸ”½ ğŸ”½ ğŸ”½ ä¸‹é¢é–‹å§‹æ”¾ä½ çš„ã€ŒçœŸæ­£è…³æœ¬ã€ ğŸ”½ ğŸ”½ ğŸ”½
--------------------------------------------------

_G.FastAttackEnabled = true

-- ===== Services =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()

local Enemies = workspace:WaitForChild("Enemies")
local Characters = workspace:WaitForChild("Characters")

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")

-- ===== åƒæ•¸ï¼ˆé‡é»ï¼‰=====
local DETECT_RANGE = 1000              -- åµæ¸¬æ•µäººè·é›¢ï¼ˆç©©ï¼‰
local HITBOX_SIZE = Vector3.new(450,450,450) -- ä¼ºæœå™¨åˆ¤å®šç¯„åœ
local ATTACK_INTERVAL = 0             -- 0 = æ¯å¹€ï¼ˆå¯æ”¹ 0.03 æ›´ç©©ï¼‰

-- ===== å·¥å…· =====
local function Alive(char)
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health > 0
end

local function GetPart(enemy)
    return enemy:FindFirstChild("HumanoidRootPart") or enemy:FindFirstChild("Head")
end

-- ===== å½è£ Hitbox =====
local HRP
local ORIGINAL_SIZE

local function ExpandHRP()
    HRP = Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return end

    ORIGINAL_SIZE = ORIGINAL_SIZE or HRP.Size
    HRP.Size = HITBOX_SIZE
    HRP.Transparency = 1
    HRP.LocalTransparencyModifier = 1
    HRP.CanCollide = false
end

local function RestoreHRP()
    if HRP and ORIGINAL_SIZE then
        HRP.Size = ORIGINAL_SIZE
    end
end

-- ===== æ”¶é›†ç›®æ¨™ =====
local function CollectTargets()
    local targets = {}
    local basePart
    local myRoot = Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return nil, targets end

    local function Scan(folder)
        for _, enemy in ipairs(folder:GetChildren()) do
            if enemy ~= Character and Alive(enemy) then
                local part = GetPart(enemy)
                if part and (part.Position - myRoot.Position).Magnitude <= DETECT_RANGE then
                    targets[#targets+1] = {enemy, part}
                    basePart = basePart or part
                end
            end
        end
    end

    Scan(Enemies)
    Scan(Characters)

    return basePart, targets
end

-- ===== FastAttack ä¸»å¾ªç’° =====
local lastAttack = 0

RunService.Heartbeat:Connect(function()
    if not _G.FastAttackEnabled then return end
    if os.clock() - lastAttack < ATTACK_INTERVAL then return end
    lastAttack = os.clock()

    local basePart, targets = CollectTargets()
    if basePart and #targets > 0 then
        -- åªåœ¨é€™ä¸€å¹€æ”¾å¤§
        ExpandHRP()

        RegisterAttack:FireServer(0)
        RegisterHit:FireServer(basePart, targets)

        -- ç«‹åˆ»é‚„åŸ
        RestoreHRP()
    end
end)

-- ===== è§’è‰²é‡ç”Ÿè™•ç† =====
Player.CharacterAdded:Connect(function(char)
    Character = char
    ORIGINAL_SIZE = nil
end)


