-- ===== 核心配置 =====
_G.FastAttackEnabled = true
local ATTACK_RANGE = 350          -- 依照要求設定為 350 米
local ATTACK_INTERVAL = 0.05      -- 攻擊頻率 (0.05s 是不掉幀且不被剔除的黃金比例)

-- ===== 服務獲取 =====
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Player = Players.LocalPlayer

-- 遠程事件路徑 (Blox Fruits 現行路徑)
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")

-- ===== 工具函數 =====
local function getChar() return Player.Character end
local function isAlive(model)
    return model and model:FindFirstChild("Humanoid") and model.Humanoid.Health > 0
end

-- ===== 核心邏輯：目標過濾 (防止遍歷過多導致掉幀) =====
local function GetTargets()
    local targets = {}
    local char = getChar()
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil, {} end
    
    local myPos = char.HumanoidRootPart.Position
    local basePart = nil

    -- 只掃描敵人資料夾，減少運算量
    for _, enemy in ipairs(workspace.Enemies:GetChildren()) do
        if isAlive(enemy) then
            local root = enemy:FindFirstChild("HumanoidRootPart") or enemy:FindFirstChild("Head")
            if root then
                local dist = (root.Position - myPos).Magnitude
                if dist <= ATTACK_RANGE then
                    table.insert(targets, {enemy, root})
                    basePart = basePart or root -- 鎖定第一個目標作為主目標
                end
            end
        end
    end
    return basePart, targets
end

-- ===== 高性能攻擊循環 =====
task.spawn(function()
    print("⚡ 350M FastAttack 已就緒 (優化不掉幀版)")
    
    while true do
        if _G.FastAttackEnabled then
            local char = getChar()
            local tool = char and char:FindFirstChildOfClass("Tool")
            
            -- 必須手持武器 (且不是槍)
            if tool and tool.ToolTip ~= "Gun" then
                local basePart, targets = GetTargets()
                
                if basePart and #targets > 0 then
                    -- 直接觸發伺服器傷害判定，不等待本地動畫
                    pcall(function()
                        RegisterAttack:FireServer(0)
                        RegisterHit:FireServer(basePart, targets)
                    end)
                end
            end
        end
        task.wait(ATTACK_INTERVAL) -- 穩定幀數的關鍵
    end
end)
