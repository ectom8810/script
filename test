_G.AdaptiveAttack = true

-- ===== Services =====
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()

local Enemies = workspace:WaitForChild("Enemies")
local Characters = workspace:WaitForChild("Characters")

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net.RE:RegisterAttack()
local RegisterHit = Net.RE:RegisterHit()

-- ===== åƒæ•¸ =====
local SCAN_RANGE = 420
local MAX_TOKENS = 6            -- æœ€å¤§é€£æ“Šæ•¸
local TOKEN_REGEN = 0.12        -- å›å¾©é€Ÿåº¦
local MOVE_THRESHOLD = 6        -- ç§»å‹•å¤šå°‘ stud æ‰é‡æ–°è¨ˆç®—

-- ===== ç‹€æ…‹ =====
local tokens = MAX_TOKENS
local lastPos
local lastTargetCount = 0

-- ===== å·¥å…· =====
local function Alive(char)
    local h = char and char:FindFirstChildOfClass("Humanoid")
    return h and h.Health > 0
end

local function GetPart(enemy)
    return enemy:FindFirstChild("HumanoidRootPart") or enemy:FindFirstChild("Head")
end

local function CollectTargets()
    local list = {}
    local base
    local hrp = Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil, list end

    local function scan(folder)
        for _, e in ipairs(folder:GetChildren()) do
            if e ~= Character and Alive(e) then
                local p = GetPart(e)
                if p and (p.Position - hrp.Position).Magnitude <= SCAN_RANGE then
                    list[#list+1] = {e, p}
                    base = base or p
                end
            end
        end
    end

    scan(Enemies)
    scan(Characters)

    return base, list
end

-- ===== Token å›å¾©ï¼ˆä½é »ï¼Œéå¸¸ä¹¾æ·¨ï¼‰=====
task.spawn(function()
    while _G.AdaptiveAttack do
        tokens = math.min(MAX_TOKENS, tokens + 1)
        task.wait(TOKEN_REGEN)
    end
end)

-- ===== ç›£æ§ç§»å‹•èˆ‡ç›®æ¨™è®ŠåŒ– =====
RunService.Stepped:Connect(function()
    if not _G.AdaptiveAttack then return end

    local hrp = Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local moved = not lastPos or (hrp.Position - lastPos).Magnitude >= MOVE_THRESHOLD
    lastPos = hrp.Position

    local base, targets = CollectTargets()
    local targetChanged = #targets ~= lastTargetCount
    lastTargetCount = #targets

    -- åªæœ‰åœ¨ã€Œæœ‰æ„ç¾©çš„ç‹€æ³ã€æ‰æ”»æ“Š
    if tokens > 0 and base and #targets > 0 and (moved or targetChanged) then
        tokens -= 1

        RegisterAttack:FireServer(0)
        RegisterHit:FireServer(base, targets)
    end
end)

-- ===== é‡ç”Ÿè™•ç† =====
Player.CharacterAdded:Connect(function(c)
    Character = c
    tokens = MAX_TOKENS
    lastPos = nil
end)

print("ğŸ§  Adaptive Burst Attack å·²å•Ÿå‹•ï¼ˆéæš´åŠ›å‹åŠŸé€Ÿï¼‰")
