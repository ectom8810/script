-- [[ 全域配置 ]] --
_G.AutoFarm = true
_G.AttackRange = 5000         -- 攻擊範圍
_G.AttackSpeed = 0.1          -- 攻擊頻率 (建議 0.1 兼顧流暢與傷害)
_G.TP_Speed = 1000            -- 瞬移速度 (每秒像素，越高越快)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Player = Players.LocalPlayer

-- 遠端事件
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")

-- [[ 改善調幀：降低渲染負載 ]] --
-- 關閉不必要的 3D 渲染，這能極大提升低階電腦的偵數 (FPS)
local function OptimizePerformance()
    settings().Rendering.QualityLevel = 1
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("Part") or v:IsA("MeshPart") then
            v.Material = Enum.Material.SmoothPlastic
            v.CastShadow = false
        end
    end
end

-- [[ 智能瞬移函數 ]] --
local function TweenTP(targetPos)
    local char = Player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local distance = (targetPos - hrp.Position).Magnitude
    local duration = distance / _G.TP_Speed

    local info = TweenInfo.new(duration, Enum.EasingStyle.Linear)
    local tween = TweenService:Create(hrp, info, {CFrame = CFrame.new(targetPos + Vector3.new(0, 15, 0))}) -- 停在目標上方 15 單位
    tween:Play()
    return tween
end

-- [[ 獲取最接近的目標 ]] --
local function GetNearestEnemy()
    local nearest = nil
    local minDist = _G.AttackRange
    local myChar = Player.Character
    if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then return nil end

    for _, enemy in ipairs(workspace.Enemies:GetChildren()) do
        local hum = enemy:FindFirstChildOfClass("Humanoid")
        local root = enemy:FindFirstChild("HumanoidRootPart")
        if hum and hum.Health > 0 and root then
            local dist = (root.Position - myChar.HumanoidRootPart.Position).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = enemy
            end
        end
    end
    return nearest
end

-- [[ 主循環 ]] --
task.spawn(function()
    OptimizePerformance()
    
    while _G.AutoFarm do
        local enemy = GetNearestEnemy()
        if enemy then
            local enemyRoot = enemy.HumanoidRootPart
            local char = Player.Character
            local myHRP = char and char:FindFirstChild("HumanoidRootPart")
            
            if myHRP then
                -- 1. 執行瞬移
                local move = TweenTP(enemyRoot.Position)
                
                -- 2. 攻擊循環 (當距離足夠近時)
                while _G.AutoFarm and enemy and enemy.Humanoid.Health > 0 do
                    if (enemyRoot.Position - myHRP.Position).Magnitude < 50 then
                        pcall(function()
                            -- 偽裝 Hitbox 並攻擊
                            local oldSize = myHRP.Size
                            myHRP.Size = Vector3.new(50, 50, 50)
                            
                            RegisterAttack:FireServer(0)
                            RegisterHit:FireServer(enemyRoot, {{enemy, enemyRoot}})
                            
                            myHRP.Size = oldSize
                        end)
                    end
                    task.wait(_G.AttackSpeed)
                end
            end
        end
        task.wait(0.5) -- 尋找下一個目標的間隔
    end
end)

print("⚡ 終極 FastAttack + 自動瞬移系統已部署")
