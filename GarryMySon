_G.FastAttack = true

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer

local Enemies = workspace:WaitForChild("Enemies")
local Characters = workspace:WaitForChild("Characters")

local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")

-- ===== 參數（已是極限）=====
local ATTACK_DISTANCE = 100000000 -- 100k
local ATTACK_DISTANCE_SQ = ATTACK_DISTANCE * ATTACK_DISTANCE

local ATTACK_CD = 0.0000000000000000000000000000000000000000000001     -- RegisterAttack 降頻（越低越兇，<0.07 易炸）
local USE_HRP = true       -- HRP 命中更穩

-- ===== 狀態 =====
local lastAttack = 0
local conn

-- ===== 工具 =====
local function Alive(char)
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health > 0
end

local function GetPart(enemy)
    if USE_HRP then
        return enemy:FindFirstChild("HumanoidRootPart") or enemy:FindFirstChild("Head")
    end
    return enemy:FindFirstChild("Head")
end

local function CollectAllTargets()
    local targets = {}
    local basePart = nil

    for _, folder in ipairs({Enemies, Characters}) do
        for _, enemy in ipairs(folder:GetChildren()) do
            if enemy ~= Player.Character and Alive(enemy) then
                local part = GetPart(enemy)
                if part then
                    targets[#targets+1] = {enemy, part}
                    basePart = basePart or part
                end
            end
        end
    end

    return basePart, targets
end

-- ===== 主循環：每幀 =====
conn = RunService.Heartbeat:Connect(function()
    if not _G.FastAttack then return end

    local char = Player.Character
    local tool = char and char:FindFirstChildOfClass("Tool")
    if not tool or tool.ToolTip == "Gun" then return end

    local basePart, targets = CollectAllTargets()
    if not basePart or #targets == 0 then return end

    -- 降頻 RegisterAttack（但 RegisterHit 每幀）
    local now = tick()
    if now - lastAttack >= ATTACK_CD then
        RegisterAttack:FireServer(0)
        lastAttack = now
    end

    RegisterHit:FireServer(basePart, targets)
end)
